---
title: "Cyclistic User Behavior Exploratory Data Analysis"
author: "JohnPaul Medina"
date: '`r Sys.Date()`'
output: html_document
---

```{r setup, include=FALSE}
library(here)
setwd(here::here())  # Forces knitting to use project root
source(here::here("simulation/simConfig.R"))
knitr::opts_chunk$set(echo = TRUE)
```

#  Uncovering Cyclistic Rider Patterns: An Exploratory Data Analysis

## Exploratory Data Analysis (EDA) Log Introduction

### Objective: 
This **Exploratory Data Analysis (EDA)** aims to identify key 
**behavioral differences** between casual riders and annual members, helping 
shape a marketing strategy to encourage casual riders to convert to membership.

### EDA Focus Areas
The analysis is structured around the following key focus points:

1. **User Distribution Analysis**

* Compare the **proportion of casual vs. member riders.**
* Identify the **scale of potential member conversions**

2. **Ride duration Patterns**

* Compare **summary statistics of ride duration** across user types.
* Determine whether casual **riders take longer trips** and how this insight can 
can be used for marketing.

3. **Time-Based Trends in Service Usage**

* **Hourly and weekly heatmaps*** to analyze user riding pattern at different 
times of the day and days of the week.
* **Seasonal trends** by analyzing monthly ride distributions to evaluate peak 
demand periods. 

4. **Bike Type Preference & Usage Patterns**

* Identify **bike type preference** between causal and member riders.
* Explore **ride duration patterns across different bike types.**

Each of these areas will provide insights to support **marketing strategies**, 
optimize **pricing model**, and improve **customer engagement initiatives.**

---

## Preliminary General Data Exploration**Distribution Analysis

First we will take a look at **rider type distribution** to understand the 
**size of our data** and how casual versus member riders are distributed.

```{r casual-versus-member-distribution-analysis}
if (!exists("cleaned_data")) {
  cleaned_data <- readRDS(cleaned_data_rds)
}

# Compute Rider Counts
member_count <- sum(cleaned_data$member_casual == "member")
casual_count <- sum(cleaned_data$member_casual == "casual")
total_accounts <- member_count + casual_count

# Create a summary table
rider_type_summary <- data.frame(
  Rider_Type = c("Casual Riders", "Member Riders", "Total Riders"),
  Count = c(casual_count, member_count, total_accounts),
  Percentage = c(
    (casual_count / total_accounts) * 100,
    (member_count / total_accounts) * 100,
    100
  )
)

# Print the result as a formatted table
knitr::kable(rider_type_summary,
             caption = "Rider Type Distribution",
             digits = 2,
             format = "pipe")
```
```{r member-vs-casual-distribution-visualization}
# Create a Data Frame for Plotting
account_counts <- data.frame(
  account_type = c("Casual", "Member"),
  count = c(casual_count, member_count)
)

# Plot Bar Chart of rider type distribution
p <- ggplot(account_counts, aes(x = account_type, 
                                y = count, fill = account_type)) +
  geom_bar(stat = "identity", width = 0.6) +  # Adjust width for aesthetics
  geom_text(aes(label = count), vjust = -0.5, size = 5, fontface = "bold") +  
  labs(
    title = "Distribution of Casual vs. Member Riders",
    x = "Account Type",
    y = "Number of Riders",
    fill = "Account Type"
  ) +
  scale_fill_manual(values = c("Casual" = "skyblue", "Member" = "darkblue")) +  
  theme_light() +  
  expand_limits(y = max(account_counts$count) * 1.1) +  
  theme(plot.margin = margin(10, 10, 10, 10))

# Display the Plot
print(p)
```
### Analysis and Key Insights

* There is an **uneven distribution** of casual(36.16%) versus member (63.84%)
riders. 
*This *high number of casual riders** presents an opportunity for 
**membership conversion marketing.**
* To ensure fair comparisons, **percentages or averages** should be used 
instead of raw counts to avoid skewed results due to the **imbalance between 
casual and member totals.**

---

Next we will conduct an analysis of ride duration between casual and member 
riders. 

```{r compare-summary-for-casual-vs-member}
# Study the summary of ride_duration of casual riders vs annual member riders
casual_summary <- 
  summary(cleaned_data$ride_duration[cleaned_data$member_casual=="casual"])
member_summary <- 
  summary(cleaned_data$ride_duration[cleaned_data$member_casual == "member"])


# Create a data frame with the summary statistics
summary_data <- data.frame(
  Statistic = rep(names(casual_summary),2),
  Value = c(as.numeric(casual_summary), as.numeric(member_summary)),
  Rider_Type = rep(c("Casual", "Member"), each = length(casual_summary))
)

# Convert the data frame to wide format for table display
ride_duration_summary <- tidyr::pivot_wider(
  summary_data,
  names_from = Rider_Type,
  values_from = Value
)

# Compute Percentage Difference only for Q1, Median, Mean, and Q3
ride_duration_summary$Percent_Difference <- ifelse(
  ride_duration_summary$Statistic %in% c("1st Qu.", "Median", "Mean", "3rd Qu."),
  round(((ride_duration_summary$Casual - ride_duration_summary$Member) / 
         ride_duration_summary$Member) * 100, 2),
  NA  # Leave Min and Max without percentage difference
)

# Display summary table
knitr::kable(ride_duration_summary,
             caption = "Ride Duration Summary by Rider Type",
             digits = 2,
             format = "pipe")
```

Bar graph of ride duration summary by rider type

```{r ride-duration-vs-rider-type-summary}
# Exclude "Max" and "Min" statistics from the data
summary_data <- summary_data %>% 
  filter(Statistic %in% c("1st Qu.", "Median", "Mean", "3rd Qu."))

# Ensure correct ordering of statistics
summary_data$Statistic <- factor(summary_data$Statistic,
                                 levels = c("1st Qu.", "Median", "Mean", "3rd Qu."))

# Create the dodge bar graph with labels
ggplot(summary_data, aes(x = Statistic, y = Value, fill = Rider_Type)) +
  geom_bar(stat = "identity", position = position_dodge(width = 0.8)) +
  geom_text(aes(label = round(Value, 2)), 
            position = position_dodge(width = 0.8), 
            vjust = -0.3, size = 4) + # Adjust vjust for padding
  scale_fill_manual(values = c("Casual" = "skyblue", "Member" = "darkblue")) +
  labs(title = "Ride Duration Summary by Rider Type (Excluding Max and Min)",
       x = "Summary Statistic",
       y = "Ride Duration (Minutes)") +
  theme_light()
```
Box plot visualization

```{r ride-duration-vs-rider-type-box-plot}
# Box plot of the summaries of casual vs member ride durations
ggplot(cleaned_data, aes(x = member_casual, y = ride_duration, fill = member_casual)) +
  geom_boxplot() + 
  scale_y_log10() +  # Apply log scale to y-axis
  labs(
    title = "Ride Duration Comparison (Log Scale)",
    x = "Account Type",
    y = "Log Ride Duration (minutes)"
  ) +
  scale_fill_manual(values = c("casual" = "skyblue", "member" = "darkblue")) + 
  theme_light()
```
### Analysis and Key Inisghts

* Based on numerical and visual comparison of the summaries of casual and 
member ride duration, casual riders tend to use the bike longer than members.
* The box plot shows that casual riders tend to take longer rides than members.
* Member ride durations from Q1 to Q3 are contained within a **narrower range**, 
indicating a more **consistent** riding pattern.

---

Next we will analyze the riders' bike preference.

```{r ride-type-vs-rider-type-percentage}
# Compute the percentage of use of ride type based on rider type.
ride_type_percentage <- cleaned_data %>% 
  group_by(member_casual, rideable_type) %>% 
  summarise(count = n(), .groups="drop") %>% 
  group_by(member_casual) %>% 
  mutate(percent = (count / sum(count)) * 100) %>% 
  ungroup()

# Convert to a table for better readability
knitr::kable(
  ride_type_percentage,
  caption = "Bike Type Usage by Rider Type (Percentage Breakdown)",
  digits = 2,
  format = "pipe"
)
```

```{r bike-type-preference-vs-rider-visualiation}
# Visualize the rideable_type vs member_casual as a bar graph
ggplot(ride_type_percentage, aes(x = rideable_type, y = percent, fill = member_casual)) +
  geom_col(position = "dodge") +
  labs(
    title = "Bike Type Preference by Rider Type (Percentage)",
    x = "Bike Type",
    y = "Percentage By Rider Type",
    fill = "Rider Type"
  ) +
  scale_fill_manual(values=c("casual"="skyblue", member="darkblue")) +
  theme_light() + 
  ylim(0, max(ride_type_percentage$percent) + 5) +
  geom_text(aes(label=sprintf("%.1f%%", percent)),
            position = position_dodge(width = 0.9), vjust = -0.5)
```

### Analysis and Key Insights

* Both casual and members show a slightly higher preference in e-bikes compared 
classic bikes which are both nearly half the rides each. 
* Rental for **e-scooters** are 3.89% for casual riders and 1.52% of the rides 
for members.
* In terms of average ride duration, casual riders use the bikes longer than 
members. Casual rider's classic bike ride duration is more than twice as long 
as that of member's classic bike rides. 

---

## Binning `ride_duration` 

Analyzing continuous data such as `ride_duration` is important but it can 
be a cause of noise in some analysis. **Binning continuous data** does not only 
organize data but it also significantly **reduce noise.**

### Identifying Bin Thresholds

* Based on previous analysis of casual and member `ride_duration` summaries, 
the **1st quadrtile** values for casual (6.78 minutes) and members (5.14 minutes) 
indicates that 5 - 7 minutes is a plausible treshold for **short rides**. 
* Upon examination of data distribution based on selected thresholds 
(see table below), the number of rides up to the 30 minute mark contains 90.19% 
of the total ride; this is a plausible threshold for **medium rides**.
* Using the same table, rides up to the 60-minute mark consists of 97.52% of 
the data. The 60-minute mark is also a point where the increase in data 
distribution slows down and thus is chosen as the upper bound for **long rides.**
* Any ride **beyond 60 minutes** is considered **extended.**

```{r table-of-ride-distribution-based-on-minutes}
# Define duration thresholds for binning consideration
duration_thresholds <- c(5, 10, 15, 20, 30, 40, 50, 60, 70, 80, 90, 100, 110, 120, 130)

# Compute total number of rides
total_rides <- nrow(cleaned_data)

# Compute the number of rides that are <= each threshold
ride_duration_summary <- data.frame(
  "Duration_Threshold (min)" = duration_thresholds,
  "Number_of_Rides" = sapply(duration_thresholds, function(x) {
    sum(cleaned_data$ride_duration <= x)
  })
)

# Compute the percentage of total rides for each range
ride_duration_summary$Percentage_of_Total <- round(
  (ride_duration_summary$Number_of_Rides / total_rides) * 100, 2
)

# Display the table
knitr::kable(
  ride_duration_summary, 
  caption = "Ride Duration Summary (Cumulative Intervals) with Percentage",
  digits = 2,
  format = "pipe"
)
```

An Empirical Cumulative Distribution Function (ECDF) plot supports the 
logic behind the identified thresholds.
```{r ECDF-ride_category}
ggplot(cleaned_data, aes(x = ride_duration)) + 
  stat_ecdf(geom = "step", color = "blue") + 
  coord_cartesian(xlim = c(0, 100)) +  # Adjust x-axis to focus on shorter rides
  geom_vline(xintercept = c(7, 30, 60), linetype = "dashed", color = "red") +
  annotate("text", x = 50, y = 0.05, label = "Thresholds: 7, 30, 60 min", 
         color = "red", size = 5, fontface = "bold", hjust = 0.5) +
  labs(
    title = "Cumulative Distribution of Ride Durations (0-100 min)",
    x = "Ride Duration (minutes)",
    y = "Proportion of Rides ≤ X Minutes"
  ) + 
  theme_light()
```

Binning and conversion of `ride_category` to a factor.

```{r binning-and-ride_category-factorization}
#Ensure that ride_duration is numeric
cleaned_data <- cleaned_data %>% 
  mutate(ride_duration = as.numeric(ride_duration))

# Set binning thresholds and add the column
cleaned_data <- cleaned_data %>% 
  mutate(ride_category = case_when(
         ride_duration <= 7 ~ "short",
         ride_duration <= 30 ~ "medium",
         ride_duration <= 60 ~ "long",
         TRUE ~ "extended"
  ))

# Convert ride_category into a factor for better plotting and order
cleaned_data <- cleaned_data %>% 
  mutate(
    ride_category = factor(ride_category, 
                           levels=c("short","medium","long","extended"))
  )

table(cleaned_data$ride_category)

#Update the dataset with the added ride_category
#saveRDS(cleaned_data, file = cleaned_data_rds) - commented out for demo
```

**Visualization** of `ride_category` bins based on percentage of total rides.
```{r ride_category-visualization}
ggplot(cleaned_data, aes(x = ride_category, fill = ride_category)) +
  geom_bar(aes(y = after_stat(count) / sum(after_stat(count)))) + 
  geom_text(
    stat = "count", 
    aes(y = after_stat(count) / sum(after_stat(count)), 
        label = scales::percent(after_stat(count) / sum(after_stat(count)), accuracy = 0.1)),
    vjust = -0.5, 
    size = 5
  ) + 
  scale_y_continuous(labels = scales::percent) +
  labs(
    title = "Proportion of Ride Categories",
    x = "Ride Category",
    y = "Percentage of Total Rides"
  ) +
  theme_minimal() +
  scale_fill_manual(values = c("short" = "blue", "medium" = "green", 
                               "long" = "orange", "extended" = "red")) +
  theme(
    plot.margin = margin(20, 20, 20, 20)  # Adds padding to prevent cutoff
  )
```


### Analysis and Key Insights
* **90.19% of rides** are 30 minutes or shorter, thus the interval 7 - 30 
minutes is an appropriate choice for "medium" duration type of ride.
* The **ECDF plot** confirms that ride duration growth slows dramatically 
after the 60 minute mark. 
* With **ride categories now set**, we can begin the analysis of **time-based** 
rider behaviors to discover trends in peak usage, hourly demands, daily demands, 
and seasonal ride fluctuations. 

---




